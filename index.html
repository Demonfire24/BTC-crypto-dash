<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC 5m Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.0/dist/chartjs-chart-financial.umd.min.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { background: #1e293b; padding: 1.5rem; border-radius: 1rem; width: 95%; max-width: 1000px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-top: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        #price { font-size: 2rem; font-weight: bold; color: #f59e0b; }
        .chart-wrapper { height: 500px; width: 100%; }
        .status { font-size: 0.7rem; color: #64748b; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div>
                <h2 style="margin: 0;">Bitcoin BTC/USDT</h2>
                <span class="status">Interval: 5m â€¢ Source: Binance</span>
            </div>
            <div id="price">Syncing...</div>
        </div>
        <div class="chart-wrapper">
            <canvas id="chart"></canvas>
        </div>
    </div>

    <script>
        // 1. Register the candlestick plugin (fixes the "hanging" issue)
        Chart.register(ChartFinancialControllers.CandlestickController, ChartFinancialControllers.CandlestickElement);

        const ctx = document.getElementById('chart').getContext('2d');
        const priceDisplay = document.getElementById('price');
        
        // 2. Setup Chart
        const chart = new Chart(ctx, {
            type: 'candlestick',
            data: {
                datasets: [{
                    label: 'BTC/USDT 5m',
                    data: [],
                    color: { up: '#22c55e', down: '#ef4444', unchanged: '#94a3b8' },
                    wickColor: { up: '#22c55e', down: '#ef4444', unchanged: '#94a3b8' }
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'timeseries', grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // 3. Pre-fill data using REST API
        async function preFillChart() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=5m&limit=50');
                const rawData = await response.json();
                const formattedData = rawData.map(d => ({
                    x: d[0], o: parseFloat(d[1]), h: parseFloat(d[2]), l: parseFloat(d[3]), c: parseFloat(d[4])
                }));
                chart.data.datasets[0].data = formattedData;
                chart.update();
                connectWebSocket(); // Only start WS after pre-fill
            } catch (err) {
                console.error("Pre-fill failed:", err);
                connectWebSocket();
            }
        }

        // 4. Connect WebSocket for live updates
        function connectWebSocket() {
            const ws = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_5m");

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                const k = msg.k;
                const candle = {
                    x: k.t, o: parseFloat(k.o), h: parseFloat(k.h), l: parseFloat(k.l), c: parseFloat(k.c)
                };

                const dataset = chart.data.datasets[0].data;
                if (dataset.length > 0 && dataset[dataset.length - 1].x === candle.x) {
                    dataset[dataset.length - 1] = candle;
                } else {
                    dataset.push(candle);
                }

                if (dataset.length > 60) dataset.shift();

                priceDisplay.innerText = `$${candle.c.toLocaleString()}`;
                chart.update('none');
            };
        }

        // Start the process
        preFillChart();
    </script>
</body>
</html>
